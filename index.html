<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <title>Grodowa Odyseja</title>
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Uncial+Antiqua&display=swap" rel="stylesheet">
  <style>
    /* ... tu wklej cały CSS jak poprzednio ... */
  </style>
</head>
<body>
  <audio id="bgMusic" src="celtic-glory-307625.mp3" autoplay loop></audio>

  <!-- wszystkie sekcje page1–page6 identycznie jak w poprzedniej wersji -->

  <!-- … -->

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const bg = document.getElementById('bgMusic');
    document.body.addEventListener('click', ()=> bg.play().catch(), { once:true });

    let team='', role='', completed=0, sideDone=false;
    const vids = {
      zwiadowca:'zwiadowca.1.mp4',
      tkaczka:'tkaczka.1.mp4',
      zielarka:'zielarka.1.mp4',
      kupiec:'kupiec.1.mp4',
      rzemieslnik:'rzemieslnik.1.mp4'
    };
    const sideTasks = [
      'Znajdź coś zielonego i dotknij to.',
      /*…*/
    ];
    const endings = {
      handel:{ name:'Otwarcie na handel', desc:'…pełny opis…' },
      granice:{ name:'Zamknięcie granic', desc:'…pełny opis…' },
      prawo:{ name:'Wprowadzenie nowego prawa', desc:'…pełny opis…' }
    };

    function show(id){
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // PRZEJŚCIE PAGE1 → PAGE2
    document.getElementById('next1').addEventListener('click', ()=>{
      const v = document.getElementById('teamName').value.trim();
      if(!v) return alert('Podaj nazwę drużyny');
      team = v;
      show('page2');
    });

    // PAGE2 → PAGE3
    document.getElementById('next2').addEventListener('click', ()=> show('page3'));

    // WYBÓR POSTACI  → odblokuj next3
    document.querySelectorAll('#page3 .role').forEach(el=>
      el.addEventListener('click', ()=>{
        document.querySelectorAll('#page3 .role').forEach(r=> r.classList.remove('selected'));
        el.classList.add('selected');
        role = el.dataset.role;
        document.getElementById('next3').disabled = false;
      })
    );

    // PAGE3 → VIDEO
    document.getElementById('next3').addEventListener('click', ()=>{
      const ov = document.getElementById('videoOverlay');
      const vid = document.getElementById('roleVideo');
      vid.src = vids[role];
      ov.style.display = 'flex';
    });

    // VIDEO → PAGE4
    document.getElementById('videoNext').addEventListener('click', ()=>{
      sideDone = false;
      completed = 0;
      show('page4');
      document.getElementById('videoOverlay').style.display = 'none';
      updateStats();
      document.getElementById('sideDone').disabled = false;
      document.getElementById('randomTask').innerText = '';
      document.querySelectorAll('.task-row').forEach(r=>{
        r.classList.remove('correct','wrong');
        r.querySelector('input').value = '';
      });
    });

    // ZADANIE POBOCZNE
    document.getElementById('randomBtn').addEventListener('click', ()=>{
      document.getElementById('randomTask').innerText =
        sideTasks[Math.floor(Math.random()*sideTasks.length)];
    });
    document.getElementById('sideDone').addEventListener('click', ()=>{
      sideDone = true;
      document.getElementById('sideDone').innerText = 'ZROBIONE';
    });

    // ZADANIA GŁÓWNE
    function updateStats(){
      document.getElementById('completedCount').innerText = completed;
      document.getElementById('toCouncil').disabled = (completed<4);
    }
    document.querySelectorAll('.task-row').forEach(row=>{
      const ans = row.dataset.ans;
      const inp = row.querySelector('input');
      const ok  = row.querySelector('.confirm');
      const clr = row.querySelector('.reset-icon');

      ok.addEventListener('click', ()=>{
        const v = inp.value.trim().toUpperCase();
        if(v===ans){
          row.classList.remove('wrong');
          if(!row.classList.contains('correct')){
            row.classList.add('correct');
            completed++;
          }
        } else {
          if(row.classList.contains('correct')){
            row.classList.remove('correct');
            completed--;
          }
          row.classList.add('wrong');
        }
        updateStats();
      });
      clr.addEventListener('click', ()=>{
        if(row.classList.contains('correct')){
          row.classList.remove('correct');
          completed--;
        }
        row.classList.remove('wrong');
        inp.value = '';
        updateStats();
      });
    });

    document.getElementById('toCouncil').addEventListener('click', ()=> show('page5'));

    // RADA → PODSUMOWANIE
    document.querySelectorAll('#page5 .btn[data-dec]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const key = b.dataset.dec;
        document.getElementById('outTeam').innerText = team;
        document.getElementById('outRole').innerText = role;
        document.getElementById('outDecisionName').innerText = endings[key].name;
        document.getElementById('outDecisionDesc').innerText = endings[key].desc;
        document.getElementById('outPortrait').src = `${role}.png`;
        document.getElementById('outSideDone').innerText = sideDone?'TAK':'NIE';
        document.getElementById('outPoints').innerText = completed;
        document.getElementById('badges').innerHTML =
          `<img src="medalion.1.png" alt="Medalion"><img src="korona.1.png" alt="Korona">`;
        document.getElementById('downloads').innerHTML =
          `<a href="medalion.1.png" download class="btn">POBIERZ MEDALION</a>
           <a href="korona.1.png" download class="btn">POBIERZ KORONĘ</a>`;
        show('page6');
      });
    });

    // RESTART
    document.getElementById('restart').addEventListener('click', ()=> location.reload());
  });
  </script>
</body>
</html>
