<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dziedzictwo ≈ªelaza ‚Äì Aplikacja</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:'Uncial Antiqua', serif; background:#1a1207; color:#f8f1d9; }
    #app { display:flex; flex-direction:column; height:100%; }
    .screen { display:none; flex:1; padding:20px; box-sizing:border-box; overflow:auto; }
    .active { display:block; }
    button { background:#7a5230; color:#fff; border:none; padding:12px; margin:10px 0; border-radius:8px; cursor:pointer; }
    button:hover { background:#96714e; }
    h1,h2 { text-align:center; color:#e0b869; }
    #map { height:60vh; margin-bottom:10px; border:3px solid #e0b869; }
    #progress { width:100%; height:20px; background:#333; border-radius:10px; overflow:hidden; margin-bottom:10px; }
    #progress div { height:100%; background:#e0b869; width:0%; transition:width 0.5s; }
    #nextPoint { text-align:center; margin-bottom:10px; }
    .task { background:#2e1b0f; padding:15px; border-radius:8px; margin-bottom:10px; }
    #dashboard { display:flex; justify-content:space-around; }
    #dashboard div { background:#2e1b0f; padding:10px; border-radius:8px; flex:1; margin:5px; }
    #chat { position:fixed; bottom:0; right:0; width:300px; background:rgba(0,0,0,0.8); border-top-left-radius:8px; }
    #chat h3 { margin:5px; }
    #chatBox { height:200px; overflow:auto; background:#1a1207; margin:5px; padding:5px; border-radius:4px; }
    #chatInput { width:70%; }
    #chatSend { width:25%; }
  </style>
</head>
<body>
<div id="app">
  <!-- 1. Animowany intro -->
  <div id="intro" class="screen active">
    <h1>üõ°Ô∏è Dziedzictwo ≈ªelaza</h1>
    <p>Odkryj przesz≈Ço≈õƒá, zdecyduj o przysz≈Ço≈õci Grodu!</p>
    <audio id="audioIntro" src="celtic-morning-call-307627.mp3"></audio>
    <button onclick="showScreen('selection')">Start</button>
  </div>
  <!-- 2. Wyb√≥r roli -->
  <div id="selection" class="screen">
    <h2>Wyb√≥r postaci</h2>
    <div id="roles"></div>
    <p id="roleBonus"></p>
    <button id="toMap" onclick="showScreen('mapView')" disabled>Rozpocznij Podr√≥≈º</button>
  </div>
  <!-- 3. G≈Ç√≥wny ekran mapy -->
  <div id="mapView" class="screen">
    <div id="map"></div>
    <div id="progress"><div id="progressBar"></div></div>
    <div id="nextPoint"></div>
    <button id="taskDetail" onclick="showTask()" disabled>Szczeg√≥≈Çy zadania</button>
  </div>
  <!-- 4. Ekran zadania -->
  <div id="taskScreen" class="screen">
    <div class="task"><h2 id="taskTitle"></h2><p id="taskDesc"></p><img id="taskImg" style="width:100%;border-radius:8px;"/></div>
    <button id="completeTask" onclick="completeTask()">Zatwierd≈∫</button>
  </div>
  <!-- 5. Dashboard poczƒÖtkowy stanu -->
  <div id="dashboardView" class="screen">
    <h2>Twoje Postƒôpy</h2>
    <div id="dashboard">
      <div>Agregacja punkt√≥w:<br/><span id="dashPoints"></span>/6</div>
      <div>Zadania poboczne:<br/><span id="dashSide"></span>/1</div>
      <div>Bonus roli:<br/><span id="dashBonus"></span></div>
    </div>
    <button onclick="showScreen('council')">Do Rady Starszych</button>
  </div>
  <!-- 6. Rada Starszych -->
  <div id="council" class="screen">
    <h2>ü™® Rada Starszych</h2>
    <p>Wybierz decyzjƒô:</p>
    <select id="councilChoice">
      <option>Otwarcie na handel</option>
      <option>Izolacja granic</option>
      <option>Adaptacja prawa</option>
    </select>
    <button onclick="finishCouncil()">Zapisz Decyzjƒô</button>
  </div>
  <!-- 7. Certyfikat -->
  <div id="certificate" class="screen">
    <h2>üéñÔ∏è Certyfikat Dziedzictwa ≈ªelaza</h2>
    <img src="certyfikat1.png" alt="Certyfikat" />
    <p>Dziƒôkujemy za udzia≈Ç w grze! Twoja decyzja wp≈Çynƒô≈Ça na przysz≈Ço≈õƒá Grodu.</p>
  </div>
</div>

<!-- Chat pomocnik√≥w -->
<div id="chat">
  <h3>Pomoc Mƒôdrc√≥w</h3>
  <div id="chatBox"></div>
  <input id="chatInput" placeholder="Zadaj pytanie..."/><button id="chatSend" onclick="sendChat()">Wy≈õlij</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
<script>
// Dane
const roles = [
  {id:'Zwiadowca',bonus:'+15% zasiƒôgu'},
  {id:'Tkaczka',bonus:'+1 hint'},
  {id:'Zielarka',bonus:'+10% czasu'},
  {id:'Kupiec',bonus:'+2 podpowiedzi'},
  {id:'Rzemie≈õlnik',bonus:'-10% trudno≈õci'},
  {id:'Starszy',bonus:'+1 decyzja'}
];
const points = [
  {id:1,name:'Brama Grodu',lat:54.44,lng:18.56,desc:'Odkryj systemy obrony',img:'task1.png'},
  {id:2,name:'Warsztat Kowala',lat:54.441,lng:18.561,desc:'Poznaj narzƒôdzia i techniki',img:'task2.png'},
  {id:3,name:'Zagroda',lat:54.442,lng:18.562,desc:'Zbadaj rolnictwo',img:'task3.png'},
  {id:4,name:'Chata Tkaczki',lat:54.443,lng:18.563,desc:'Odszyfruj wzory',img:'task4.png'},
  {id:5,name:'Chata Zielarki',lat:54.444,lng:18.564,desc:'Zbadaj zio≈Ça',img:'task5.png'},
  {id:6,name:'Kamie≈Ñ Decyzji',lat:54.445,lng:18.565,desc:'Ostatnia Rada',img:'task6.png'}
];
let selectedRole=null, sideTask=null, completed=0, visited=[];
let map, marker, currentIndex=0;

// Inicjalizacja
window.onload=()=>{
  document.getElementById('audioIntro').play();
  // Roles
  const rdiv=document.getElementById('roles');
  roles.forEach(r=>{
    const btn=document.createElement('button'); btn.innerText=r.id;
    btn.onclick=()=>{
      selectedRole=r.id; sideTask=roles.find(x=>x.id===r.id).bonus;
      document.getElementById('roleBonus').innerText=`Bonus: ${r.bonus}`;
      document.getElementById('toMap').disabled=false;
      document.getElementById('dashBonus').innerText=r.bonus;
    };
    rdiv.appendChild(btn);
  });
  // Map
  map=L.map('map').setView([points[0].lat,points[0].lng],15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  points.forEach(p=>{
    L.marker([p.lat,p.lng]).addTo(map).bindPopup(p.name);
  });
  map.on('locationfound',locate);
  map.locate({watch:true,enableHighAccuracy:true});
};

function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}

function complete(id){if(visited.includes(id)) return;visited.push(id);completed++;document.getElementById('progressBar').style.width=((visited.length/6)*100)+'%';document.getElementById('doneCount').innerText=completed; if(visited.length>=4) document.getElementById('toCouncil').disabled=false;}

function locate(e){
  if(marker) marker.remove();
  marker=L.circleMarker(e.latlng,{color:'#e0b869'}).addTo(map);
  // Oblicz najbli≈ºszy nieodwiedzony
  const dists=points.filter(p=>!visited.includes(p.id)).map(p=>({p,dist:map.distance(e.latlng,[p.lat,p.lng])}));
  if(dists.length){
    dists.sort((a,b)=>a.dist-b.dist);
    const next=dists[0];
    document.getElementById('nextPoint').innerText=`Nastƒôpny: ${next.p.name} ‚Äì ${(next.dist|0)}m`;
    if(next.dist<50){document.getElementById('taskDetail').disabled=false;document.getElementById('taskDetail').onclick=()=>showTask(next.p);}    
  }
}

function showTask(point){
  document.getElementById('taskTitle').innerText=point.name;
  document.getElementById('taskDesc').innerText=point.desc;
  document.getElementById('taskImg').src=point.img;
  showScreen('taskScreen');
}

function completeTask(){
  const title=document.getElementById('taskTitle').innerText;
  const p=points.find(x=>x.name===title);
  complete(p.id);
  showScreen('mapView');
}

function finishCouncil(){ showScreen('certificate'); }

// Chat
function sendChat(){ const inp=document.getElementById('chatInput'); const txt=inp.value.trim(); if(!txt) return; const box=document.getElementById('chatBox'); box.innerHTML+=`<div><strong>Ty:</strong> ${txt}</div>`; setTimeout(()=>{box.innerHTML+=`<div><strong>Mƒôdrzec:</strong> Sprawd≈∫ punkt ${points[currentIndex%6].name}.</div>`; box.scrollTop=box.scrollHeight;},500); inp.value=''; }
</script>
</body>
</html>
